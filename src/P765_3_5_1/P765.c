/********************************************************************************************
* SIDH: an efficient supersingular isogeny cryptography library
*
* Abstract: supersingular isogeny parameters and generation of functions for P765
*********************************************************************************************/  

#include "P765_api.h" 
#include "P765_internal.h"


// Encoding of field elements, elements over Z_order, elements over GF(p^2) and elliptic curve points:
// --------------------------------------------------------------------------------------------------
// Elements over GF(p) and Z_order are encoded with the least significant octet (and digit) located at the leftmost position (i.e., little endian format). 
// Elements (a+b*i) over GF(p^2), where a and b are defined over GF(p), are encoded as {a, b}, with a in the least significant position.
// Elliptic curve points P = (x,y) are encoded as {x, y}, with x in the least significant position. 
// Internally, the number of digits used to represent all these elements is obtained by approximating the number of bits to the immediately greater multiple of 32.
// For example, a 765-bit field element is represented with Ceil(765 / 64) = 12 64-bit digits or Ceil(765 / 32) = 24 32-bit digits.

//
// Curve isogeny system "SIDHp765". Base curve: Montgomery curve By^2 = Cx^3 + Ax^2 + Cx defined over GF(p765^2), where A=0, B=1, C=1 and p765 = 2^388*3^119*5^81-1
//
         
const uint64_t p765[NWORDS64_FIELD]              = { 0xFFFFFFFFFFFFFFFF, 0xFFFFFFFFFFFFFFFF, 0xFFFFFFFFFFFFFFFF, 0xFFFFFFFFFFFFFFFF, 0xFFFFFFFFFFFFFFFF, 0xFFFFFFFFFFFFFFFF, 0xAFA37E4ADE8AD36F, 0x295AB216AE6E7F61, 0x4CFB7AF5840E37DB, 0xC62A44C95DC67031, 0xBCBF3BE3A0B668BC, 0x19C0F8DEC9ABD1D5 };
const uint64_t p765p1[NWORDS64_FIELD]            = { 0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0xAFA37E4ADE8AD370, 0x295AB216AE6E7F61, 0x4CFB7AF5840E37DB, 0xC62A44C95DC67031, 0xBCBF3BE3A0B668BC, 0x19C0F8DEC9ABD1D5 };
const uint64_t p765x2[NWORDS64_FIELD]            = { 0xFFFFFFFFFFFFFFFE, 0xFFFFFFFFFFFFFFFF, 0xFFFFFFFFFFFFFFFF, 0xFFFFFFFFFFFFFFFF, 0xFFFFFFFFFFFFFFFF, 0xFFFFFFFFFFFFFFFF, 0x5F46FC95BD15A6DF, 0x52B5642D5CDCFEC3, 0x99F6F5EB081C6FB6, 0x8C548992BB8CE062, 0x797E77C7416CD179, 0x3381F1BD9357A3AB }; 
// Order of Alice's subgroup
const uint64_t Alice_order[NWORDS64_ORDER]       = { 0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0010000000000000 }; 
// Order of Bob's subgroup
const uint64_t Bob_order[NWORDS64_ORDER]         = { 0xCAFAFEF93AFA16CB, 0xD8905F6B9E84C93A, 0x186DE33CDDEA5C9, 0x7BF3F22AC4F809C5, 0xAD34051767BDAE34, 0x10DE1593369D1B5F }; //3^119, 5^81

const uint64_t A_gen[5 * NWORDS64_FIELD]  = {
0x2F873359CDB5B630,0x1FCEE5F1A9BB8792,0xE71BDB0919F67780,0x74DA37641D5F588,0x431FB16D95E642CE,0x64C7D4997E45958C,0x76878A309DFA2B5D,0xE39656381BF0703,0xE22812322FC5D797,0x8F9396C74D4B6A33,0x207239C8A6E92887,0x5FFBE747561B0E7,//XPA0
0x49756AE4B7A039A3,0x589A9E842A7E3485,0xFFF68BEC121EC207,0x78ACEBC402CA9DD6,0xB7F02B8C048A99E1,0x137832CD2405312C,0x37B9FE950443E493,0xA42B79AD4CF9CEB5,0x168D70D1D8A0B8A,0x660181459286300F,0xB779881C931125A8,0xD3AAB1B15052A65,//XPA1
0xE7AC388FDC11D7A2,0x9DDADCA41867DBC8,0x1BB1688D07D6C21E,0x39BCA51ACEC06DAE,0x5D20B7C8157DE59F,0xE65394A5D79A2F4,0x4F0337E2380F4746,0xC7F143C2DDDA74E0,0xC7FC8149F0D9835F,0x882456D4D64054C0,0x2E81022EBECB3300,0x90E6A7EF16A27A6,//XQA
0x9171B0B5CF54D0B9,0x86C8FB4DAF338A53,0xE645979929AC1E06,0xD93718F1CDEAD6CB,0x90F9422F25D36ED0,0x378DC7B9C292CAB,0xD0884FDFD157EA32,0xC817E633A167ECA8,0xA9EA603471348C8E,0xE9A8B4C361433A0F,0xEB1EBF779220E727,0x1264C03961C69E36,//XRA0
0x419B61DB5D83A4C6,0xAE3B4698D791B7E1,0xD9FF588B5CFBBB29,0xE0DA1218F85FA3C6,0xEF4ED73AA965067F,0xAA1346D550195638,0xAA64AC064BB68BF4,0x6D200F001C0370C3,0xD8EBD81D1DAF98C1,0x43DEF335176DFB32,0x92C2C3CC2A45D2AB,0x114F79DFB31DB399//XRA1    
};

const uint64_t B_gen[5 * NWORDS64_FIELD]  = {
0xB88C77F9BBA4CBAF,0x427D68DF5F183394,0xF9B14CC252334DCE,0xCE3A2CA9975842CB,0xC9BBF3CAA6A542A7,0xD1AF97CC0E464E3D,0xBA3EE3EA3C9D87DA,0x2D5938E2AF370D8E,0xDFAC94C964A4D4AF,0x80ED7A99AAD1D0A,0xAB85FD74FCA3244,0x337C6397007A88,
0x91D6BCC80C3F40A2,0xBCD12753CE4656B8,0x7A84512FB2C1D7AD,0xF9FC5B46B8E95C0C,0x6141584FF00874D5,0xEC336032E09033A2,0x82DC7EB3A4418F49,0xBF96BC6F748A79B8,0x46706559EA299430,0xA7A50DA469BF5D4B,0x4B25DAD1A682CEE3,0xFFA97BDE80577A1,
0x996C664E69EE85F2,0xFCBF119EB29F0BFC,0x8729ECCB00843EDE,0x2EFDBAAED92AA40E,0xE97AA3DD1140B3D4,0x20301D7A25FDBE9C,0xAB47ACFBAE947AD2,0xF2088B023599A44F,0xC3AF05127A31204,0x20E708BAC13A2683,0x7C1FC7FFF2CBC9A3,0x126852244C698A5A,
0x6591BE07359F75B1,0xE7B8D7C939F91FA3,0xA81C84A06A49011C,0x75E6AA71A9A95807,0x5ADA570F8507173,0xBFCB22CE2CEED5FB,0x9C656DDEBDA40777,0xB4DB572D7DF85F52,0xFEAB03A0D8B606D3,0x259F7786321EFBEC,0xAB5A62DC62461D65,0x164A6A26AF945756,
0x12CB30E2369003D8,0xCDDD25C6BC54BAA8,0x775BACAFA9D7B546,0xEF4703511AB4BE2,0x1309FF17DFF09C0E,0x9CD1C62BC2D1CFFC,0x67FECF7582CA7832,0x72086FF6470CA44A,0xC84F92A93F9BCF3A,0xD0A0AF77E54418E5,0x125D57FCAF1F3D99,0xCCB11FF8D21B4E4};

const uint64_t B1_gen[5 * NWORDS64_FIELD]  = {
0x817868397AA6FBC4,0x4D30C501C62A0D0D,0x6ECFF59D4A940A36,0x4614E8F46A4A8076,0x9DEF19E0E86447DC,0xE57C9D4383D9702D,0x4E7D6E4E76444565,0xAF6B4511149F395A,0xDD7FD8DA906D57D8,0x10C6C800DD9B8504,0xCF1DB2D39F975839,0x77D8093FEB951DB,
0x9D84EF5475A83330,0x55B17E9A144640A6,0xCB0D6F09E07E7132,0x7342DE6B1B34EBA0,0xD7595BC591483A2C,0x96D62DD688F42381,0xF112C558B1EEDA,0xB254597C429C8550,0x5A4FB08BFE74B406,0x4720CD64F893D151,0xE218F0FB7A4AF8B8,0xF8206B6B7ED71FC,
0xC1D0CD3297504101,0xAFE0340E0113B79E,0xF3ABCD681B56BFFD,0xF69F25F5FF40ECA2,0x12A7805E998D8045,0x53E52D75780AEBA1,0x2CB9186A291ED9BC,0x50739DD27F426A92,0x3EBC3F63FADDA4EA,0x846EC418D748D7D0,0x8F95729E513B1B71,0xA8722C0DC0BD6EB,
0x165BEBFC419E5F41,0x8CDDD4CE8DBF2079,0x91A7E327FF92FCB8,0x16CCD22FD997B2B4,0x2F851EE97F7F84DA,0xEACC33A9118A2E21,0x675E92961F0A32F3,0xCEB957FC94D83885,0x5E5A71BD8C64A297,0x344F222E5F58A192,0x6232C332F2758677,0x514A176709BC3AF,
0xF7DECCADA4050D14,0x9B3DBD8C9B8DC6DB,0xFBB5DAB5C9260256,0xAF3A605B83D106D3,0x51981EB02C73F32E,0xA25C15699080791,0x1D9DA341B49DC6F,0xC02AA8763524EA8C,0xA0AF2083375238B2,0xEDAA46A66368C588,0xB65BFB8DB74FEA70,0x479C8C7A3F38277};

const uint64_t B2_gen[5 * NWORDS64_FIELD]  = {
0x9FA0D5530521A911,0x4B72E86A9B10E729,0x1CF00A856F8DCFA3,0x9943C75F15AB31A0,0xC8E210EFF9C96C3,0x2774B3CD49826D6,0xA3EFDCF52325DED2,0x61A6A2E53110FAFD,0x7636CCCBCFE81812,0xF097FB8A255248A0,0xF6B1F97C135C6B1E,0xEAB965FF2F72AF4,
0x5F12B0A241B86BFE,0x6C163CD4CABEDA15,0xC1FE1305C877AD5F,0xD6ED08CAFBA8C259,0xC8F4937D099310F0,0x77214E5DEA31C13C,0xC6179B78F72486F5,0xCD195C57A1F90810,0x149D3354EEEDB654,0xC626DCA3132059D9,0xB3CC565A62B0265D,0xCE47750C7591295,
0xF052A37FC0A81B48,0x9B9134861203AEEA,0xC33A4C08B1271C2,0xBBEAB25A1349FC7A,0xA4EF38969E93D31E,0x8297036CB731B88B,0xA601DA4DD0C12181,0xBA42CEDD6FC5F323,0x8EF7790BB8EB1DCB,0xD6D0E98387016F16,0x7F6FF641057065DE,0x1373AD817DE545BA,
0xB0676D5CF7E24729,0xAA2A2044E16D21E1,0xA80462C5722E1343,0x6A70CC0545CD7110,0x79AFB44F67638A3E,0xAAD2BAB3E14E5CCA,0x63F448E7B3C1CDEC,0x1FC98834314879BB,0xBCF3028271202D83,0x9CE1697831E1ED1D,0xB1CC7E116D3ECC26,0x10B6D1BC9028842E,
0x1128200BBF611FA2,0x8BD5E948E2007EFD,0x30499615C7E790C2,0xAA7FA236B1E819C9,0xA082CD57869EF6C0,0x8707CA5240E2B9A1,0x282123896D7D62A2,0xB3BF26D98BD512B2,0x8667F9D19013ACD0,0xB8583D7CE38DC49D,0x3C5ABCCB97E0D1DE,0x5500D15C105F0AE};


// Montgomery constant Montgomery_R2 = (2^768)^2 mod p765
const uint64_t Montgomery_R2[NWORDS64_FIELD]     = { 0xEC9BE50DAF9DE30D, 0x25017A3054A35672, 0xF6399F2C57B42B5D, 0x8B6333BD597267E1, 0x659F6BF442DD8D7E, 0x39229C8DA2EF60BE, 0x51A130ECC7AFA216, 0x60C45060C487614E, 0x8F106BA2061C5A1A, 0x4B1213BC163AF789, 0x1EEACE844B7CE0D8, 0x145DF1C042224502 };                                                    
// Value one in Montgomery representation 
const uint64_t Montgomery_one[NWORDS64_FIELD]    = { 0x0000000000000009, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0xD3408F5E2D1E9110, 0x8BCFBD33DE1D8590, 0x4B28AD5E5B80094B, 0x88394EBB4060E44, 0x5D46E4FF5996515D, 0x1837402AE8F59F7C };     
// Value (2^384)^2 mod 3^239                                                   
const uint64_t Montgomery_Rprime[NWORDS64_ORDER] = { 0x1A55482318541298, 0x070A6370DFA12A03, 0xCB1658E0E3823A40, 0xB3B7384EB5DEF3F9, 0xCBCA952F7006EA33, 0x00569EF8EC94864C };
// Value -(3^239)^-1 mod 2^384 
const uint64_t Montgomery_rprime[NWORDS64_ORDER] = { 0x48062A91D3AB563D, 0x6CE572765303C2F5, 0x5D1319F3F160EC9D, 0xE35554E8C2D5623A, 0xCA29300232BC79A5, 0x8AAD843D646D78C5 };                                           


// Fixed parameters for isogeny tree computation
const unsigned int strat_Alice[MAX_Alice] = 
{ 79, 48, 27, 15, 8, 4, 2, 1, 1, 1, 2, 1, 1, 4, 2, 1, 1, 2, 1, 1, 7, 4, 2, 1, 1, 2, 1, 1, 3, 2, 1, 1, 1, 1, 12, 7, 4, 2, 1, 1, 2, 1, 
1, 3, 2, 1, 1, 1, 1, 5, 3, 2, 1, 1, 1, 1, 2, 1, 1, 1, 21, 12, 7, 4, 2, 1, 1, 2, 1, 1, 3, 2, 1, 1, 1, 1, 5, 3, 2, 1, 1, 1, 1, 2, 1, 1, 
1, 9, 5, 3, 2, 1, 1, 1, 1, 2, 1, 1, 1, 4, 2, 1, 1, 1, 2, 1, 1, 32, 20, 12, 7, 4, 2, 1, 1, 2, 1, 1, 3, 2, 1, 1, 1, 1, 5, 3, 2, 1, 1, 1,
1, 2, 1, 1, 1, 8, 5, 3, 2, 1, 1, 1, 1, 2, 1, 1, 1, 4, 2, 1, 1, 2, 1, 1, 15, 8, 4, 2, 1, 1, 1, 2, 1, 1, 4, 2, 1, 1, 2, 1, 1, 7, 4, 2, 
1, 1, 2, 1, 1, 3, 2, 1, 1, 1, 1 };
const unsigned int strat_Bob1[MAX_Bob1] = 
    {  41, 27, 18, 12, 8, 5, 3, 2, 1, 1, 1, 1, 1, 2, 1, 1, 1, 3, 2, 1, 1, 1, 1, 1, 4, 3, 2, 1, 1, 1, 1, 1, 1, 1, 1, 6, 4, 3, 2, 1, 1, 1, 1,
1, 1, 1, 1, 2, 1, 1, 1, 1, 9, 6, 4, 3, 2, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1, 1, 1, 1, 3, 2, 1, 1, 1, 1, 1, 1, 14, 9, 6, 4, 3, 2, 1, 1, 1, 
1, 1, 1, 1, 1, 2, 1, 1, 1, 1, 3, 2, 1, 1, 1, 1, 1, 1, 5, 3, 2, 1, 1, 1, 1, 1, 1, 2, 1, 1, 1 };
const unsigned int strat_Bob2[MAX_Bob2] = 
    {33, 20, 12, 7, 4, 2, 1, 1, 1, 2, 1, 1, 3, 2, 1, 1, 1, 1, 5, 3, 2, 1, 1, 1, 1, 2, 1, 1, 1, 8, 5, 3, 2, 1, 1, 1, 1, 2, 1, 1, 1, 3, 2, 
1, 1, 1, 1, 1, 13, 8, 5, 3, 2, 1, 1, 1, 1, 2, 1, 1, 1, 3, 2, 1, 1, 1, 1, 1, 5, 3, 2, 1, 1, 1, 1, 1, 2, 1, 1, 1 };



// Setting up macro defines and including GF(p), GF(p^2), curve, isogeny and kex functions
#define fpcopy                        fpcopy765
#define fpzero                        fpzero765
#define fpadd                         fpadd765
#define fpsub                         fpsub765
#define fpneg                         fpneg765
#define fpdiv2                        fpdiv2_765
#define fpcorrection                  fpcorrection765
#define fpmul_mont                    fpmul765_mont
#define fpsqr_mont                    fpsqr765_mont
#define fpinv_mont                    fpinv765_mont
#define fpinv_chain_mont              fpinv765_chain_mont
#define fpinv_mont_bingcd             fpinv765_mont_bingcd
#define fp2copy                       fp2copy765
#define fp2zero                       fp2zero765
#define fp2add                        fp2add765
#define fp2sub                        fp2sub765
#define fp2neg                        fp2neg765
#define fp2div2                       fp2div2_765
#define fp2correction                 fp2correction765
#define fp2mul_mont                   fp2mul765_mont
#define fp2sqr_mont                   fp2sqr765_mont
#define fp2inv_mont                   fp2inv765_mont
#define fp2inv_mont_bingcd            fp2inv765_mont_bingcd
#define fpequal_non_constant_time     fpequal765_non_constant_time
#define sqr_asm                       sqr765_asm
#define mp_add_asm                    mp_add765_asm
#define mp_subx2_asm                  mp_sub765x2_asm
#define mp_dblsubx2_asm               mp_dblsub765x2_asm
#define crypto_kem_keypair            crypto_kem_keypair_SIKEp765
#define crypto_kem_enc                crypto_kem_enc_SIKEp765
#define crypto_kem_dec                crypto_kem_dec_SIKEp765
#define random_mod_order_A            random_mod_order_A_SIDHp765
#define random_mod_order_B            random_mod_order_B_SIDHp765
#define EphemeralKeyGeneration_A      EphemeralKeyGeneration_A_SIDHp765
#define EphemeralKeyGeneration_B      EphemeralKeyGeneration_B_SIDHp765
#define EphemeralSecretAgreement_A    EphemeralSecretAgreement_A_SIDHp765
#define EphemeralSecretAgreement_B    EphemeralSecretAgreement_B_SIDHp765
    
//Setting up xMUL and Isogeny functions
#define xMULe2                          xQPLe
#define get_d2_isog                     get_5_isog
#define eval_d2_isog                    eval_5_isog
    

#include "../fpx.c"
#include "../ec_isogeny.c"
#include "../sidh.c"
#include "../sike.c"
